# AAPT2 ‰∫ßÁâ©ÈÄÜÂêë

## ‰∏∫‰ªÄ‰πàË¶ÅÈÄÜÂêë *AAPT2* ‰∫ßÁâ©

Ê†πÊçÆ‰∏ä‰∏ÄÁ´†Êàë‰ª¨ÂØπ *Android* Â∑•Á®ãÁöÑÊûÑÂª∫ÊµÅÁ®ãÁöÑ‰∫ÜËß£ÔºåÂ¶ÇÊûúË¶ÅÂ§ÑÁêÜ *APP* ‰∏≠ÁöÑËµÑÊ∫êÔºå‰∏ÄËà¨‰ºöÈÄâÊã©‰ªé *processRes* ‰ªªÂä°ÁöÑ‰∫ßÂá∫Áâ©‰∏≠Ëé∑ÂèñÔºåËÄå‰ªé *Android Gradle Plugin 3.0.0* ÂºÄÂßãÔºå*processRes* ‰ªªÂä°ÁöÑ‰∫ßÂá∫Áâ©Â∑≤Áªè‰∏çÂÜçÊòØÂéüÂßãÁöÑËµÑÊ∫êÊñá‰ª∂‰∫ÜÔºåËÄåÊòØÁî±ÁâπÂÆöÁöÑÊ†ºÂºèÔºà*AAPT2*ÔºâÊâÄÁºñÁ†ÅÁöÑ‰∫åËøõÂà∂„ÄÇ

Âú® *Booster* ÁöÑ‰ºòÂåñÁâπÊÄß‰∏≠ÔºåÊúâÂæàÂ§öÁâπÊÄßÁöÑÊù•ÂÆûÁé∞ÈÉΩ‰æùËµñ‰∫éËß£ÊûêËøô‰∫õË¢´ *AAPT2* ÁºñËØëËøáÁöÑ‰∫åËøõÂà∂ËµÑÊ∫êÔºå‰æãÂ¶ÇÔºö

1. [booster-task-analyser](https://github.com/didi/booster/tree/master/booster-task-analyser) ‰ª•Â∏ÉÂ±ÄÊñá‰ª∂‰∏≠ÁöÑËá™ÂÆö‰πâ *View* ‰Ωú‰∏∫ÈùôÊÄÅÂàÜÊûêÁöÑÂÖ•Âè£Êù•ÊûÑÂª∫ *Call Graph*Ôºõ
1. [booster-transform-r-inline](https://github.com/didi/booster/tree/master/booster-transform-r-inline) ‰ªéÂ∏ÉÂ±ÄÊñá‰ª∂‰∏≠ÊèêÂèñ *ConstraintLayout* ÂºïÁî®ÁöÑËµÑÊ∫ê *ID*Ôºõ
1. [booster-task-compression-pngquant](https://github.com/didi/booster/tree/master/booster-task-compression-pngquant) Âíå [booster-task-compression-cwebp](https://github.com/didi/booster/tree/master/booster-task-compression-cwebp) ‰ªé *&#42;.png.flat* Êñá‰ª∂‰∏≠Ëé∑ÂèñÂõæÁâáËµÑÊ∫êÂêçÁß∞ÂèäÂÖ∂Ê∫êÊñá‰ª∂Ë∑ØÂæÑÔºõ
1. [booster-task-resource-deredundancy](https://github.com/didi/booster/tree/master/booster-task-resource-deredundancy) ‰ªé *&#42;.png.flat* Êñá‰ª∂‰∏≠Ëé∑ÂèñÂõæÁâáËµÑÊ∫êÁöÑ *Configuration*Ôºõ

## ‰ªÄ‰πàÊòØ AAPT2 ?

*AAPT2*Ôºà*Android* ËµÑÊ∫êÊâìÂåÖÂ∑•ÂÖ∑ÔºâÊòØ‰∏Ä‰∏™ÊûÑÂª∫Â∑•ÂÖ∑Ôºå*Android Studio* Âíå *Android Gradle Plugin* ‰ΩøÁî®ÂÆÉÊù•ÁºñËØëÂíåÊâìÂåÖÂ∫îÁî®ÁöÑËµÑÊ∫ê„ÄÇ*AAPT2* ‰ºöËß£ÊûêËµÑÊ∫ê„ÄÅ‰∏∫ËµÑÊ∫êÁºñÂà∂Á¥¢ÂºïÔºåÂπ∂Â∞ÜËµÑÊ∫êÁºñËØë‰∏∫ÈíàÂØπ Android Âπ≥Âè∞ËøõË°åËøá‰ºòÂåñÁöÑ‰∫åËøõÂà∂Ê†ºÂºè„ÄÇ

*AAPT2* ÁöÑÂèØÊâßË°åÊñá‰ª∂Èöè *Android SDK* ÁöÑ *Build Tools* ‰∏ÄËµ∑ÂèëÂ∏ÉÔºå‰ª• *Build Tools 29.0.0* ‰∏∫‰æãÔºå*aapt2* ÂèØÊâßË°åÊñá‰ª∂‰Ωç‰∫éÔºö

```
$ANDROID_HOME/build-tools/29.0.0/aapt2
```

‰ªé *Android Gradle Plugin 3.0.0* ÂºÄÂßãÔºå*AAPT2* ÈªòËÆ§ÂºÄÂêØÔºåÁõ∏ÂØπ‰∫é *AAPT*ÔºåËµÑÊ∫êÊâìÂåÖÊµÅÁ®ãÁî±ÂéüÊù•ÁöÑÂçï‰∏ÄÁºñËØëËøáÁ®ãÊãÜÂàÜ‰∏∫„ÄåÁºñËØë„ÄçÂíå„ÄåÈìæÊé•„Äç‰∏§‰∏™Èò∂ÊÆµ„ÄÇ

### ÁºñËØëÈò∂ÊÆµ

*Android* ÊâÄÊúâÁ±ªÂûãÁöÑËµÑÊ∫êÁöÑÁºñËØëÈÉΩÊòØÈÄöËøá *AAPT2* Êù•ÂÆåÊàêÔºåËµÑÊ∫êÁöÑÁºñËØë‰ΩøÁî® *compile* Â≠êÂëΩ‰ª§ÔºåÁºñËØëÊàêÂäüÂêéÔºå‰ºöÁîüÊàê‰∏Ä‰∏™Êâ©Â±ïÂêç‰∏∫ *.flat* ÁöÑ‰∏≠Èó¥‰∫åËøõÂà∂Êñá‰ª∂ÔºåÊ≠£Â∏∏ÊÉÖÂÜµ‰∏ãÔºåÊØè‰∏Ä‰∏™ËæìÂÖ•ÁöÑËµÑÊ∫êÊñá‰ª∂ÂØπÂ∫îËæìÂá∫‰∏Ä‰∏™ *.flat* Êñá‰ª∂ÔºåÁÑ∂ÂêéÂú®ÂêéÁª≠ÁöÑÈìæÊé•Èò∂ÊÆµ‰ΩøÁî®„ÄÇ

#### ÁºñËØëÂçï‰∏™ËµÑÊ∫ê

```bash
$ aapt2 compile -o build ./app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
```

#### ÁºñËØëÂ§ö‰∏™ËµÑÊ∫ê

```bash
$ aapt2 compile -o build \
    ./app/src/main/res/mipmap-xxxhdpi/ic_launcher.png \
    ./app/src/main/res/layout/activity_main.xml \
    ./app/src/main/res/values/strings.xml
```

#### ÁºñËØëÊï¥‰∏™ÁõÆÂΩï

```bash
$ aapt2 compile -o build/resources.ap_  --dir ./app/src/main/res/
```

ÈÄöËøá *unzip* ÂëΩ‰ª§Êü•Áúã *build/resources.ap_* Êñá‰ª∂ÂÜÖÂÆπÔºö

```bash
$ unzip -lv build/resources.ap_
```

ÁªìÊûúÂ¶Ç‰∏ãÔºö

```
Archive:  build/resources.ap_
 Length   Method    Size  Cmpr    Date    Time   CRC-32   Name
--------  ------  ------- ---- ---------- ----- --------  ----
    2964  Stored     2964   0% 01-01-1980 08:00 222c02e4  drawable-v24_ic_launcher_foreground.xml.flat
   10400  Stored    10400   0% 01-01-1980 08:00 c51d04d8  drawable_ic_launcher_background.xml.flat
    1004  Stored     1004   0% 01-01-1980 08:00 b7942223  layout_activity_main.xml.flat
     468  Stored      468   0% 01-01-1980 08:00 719ae087  mipmap-anydpi-v26_ic_launcher.xml.flat
     480  Stored      480   0% 01-01-1980 08:00 51d410e6  mipmap-anydpi-v26_ic_launcher_round.xml.flat
    3076  Stored     3076   0% 01-01-1980 08:00 b7c61139  mipmap-hdpi_ic_launcher.png.flat
    5032  Stored     5032   0% 01-01-1980 08:00 4e0c4c11  mipmap-hdpi_ic_launcher_round.png.flat
    2172  Stored     2172   0% 01-01-1980 08:00 8403a200  mipmap-mdpi_ic_launcher.png.flat
    2908  Stored     2908   0% 01-01-1980 08:00 fa7067cb  mipmap-mdpi_ic_launcher_round.png.flat
    4604  Stored     4604   0% 01-01-1980 08:00 7d50d1c1  mipmap-xhdpi_ic_launcher.png.flat
    7020  Stored     7020   0% 01-01-1980 08:00 b81236dd  mipmap-xhdpi_ic_launcher_round.png.flat
    6504  Stored     6504   0% 01-01-1980 08:00 087eaa8c  mipmap-xxhdpi_ic_launcher.png.flat
   10544  Stored    10544   0% 01-01-1980 08:00 a3248946  mipmap-xxhdpi_ic_launcher_round.png.flat
    9056  Stored     9056   0% 01-01-1980 08:00 da999b7f  mipmap-xxxhdpi_ic_launcher.png.flat
   15260  Stored    15260   0% 01-01-1980 08:00 3c9e8eea  mipmap-xxxhdpi_ic_launcher_round.png.flat
     296  Stored      296   0% 01-01-1980 08:00 eeebffe4  values-v13_styles.arsc.flat
     296  Stored      296   0% 01-01-1980 08:00 08cc005e  values-v21_styles.arsc.flat
     332  Stored      332   0% 01-01-1980 08:00 3050ad73  values_colors.arsc.flat
     248  Stored      248   0% 01-01-1980 08:00 b5f978d1  values_strings.arsc.flat
     284  Stored      284   0% 01-01-1980 08:00 b1096c78  values_styles.arsc.flat
--------          -------  ---                            -------
   82948            82948   0%                            20 files
```

::: warning
Ê≥®ÊÑèÔºöÂØπ‰∫éËµÑÊ∫êÊñá‰ª∂ÔºåËæìÂÖ•Êñá‰ª∂ÁöÑË∑ØÂæÑÂøÖÈ°ªÁ¨¶Âêà‰ª•‰∏ãÁªìÊûÑÔºöpath/`resource-type`[-`configuration`]/fileÔºåÂê¶ÂàôÔºå‰ºöÊä•Â¶Ç‰∏ãÈîôËØØÔºö

*error: invalid file path '...'*
:::

### ÈìæÊé•Èò∂ÊÆµ

Âú®ÈìæÊé•Èò∂ÊÆµÔºå*AAPT2* ‰ºöÂêàÂπ∂Âú®ÁºñËØëÈò∂ÊÆµÁîüÊàêÁöÑÊâÄÊúâ‰∏≠Èó¥Êñá‰ª∂Ôºà*.flat* Êñá‰ª∂ÔºâÔºåÂπ∂Â∞ÜÂÆÉ‰ª¨ÊâìÂåÖÊàê *ZIP* ÂåÖÔºàÊúÄÁªà *APK* ÁöÑÂéüÂûãÔºåÁî±‰∫é‰∏çÂåÖÊã¨ *DEX* Êñá‰ª∂‰∏îÊú™Á≠æÂêçÔºåÊâÄ‰ª•Êó†Ê≥ïÊ≠£Â∏∏ÂÆâË£ÖÔºâ„ÄÇ

ÈìæÊé•ËµÑÊ∫ê‰ΩøÁî® *link* Â≠êÂëΩ‰ª§ÔºåÂ¶Ç‰∏ãÊâÄÁ§∫Ôºö

```bash
$ aapt2 link -o build/resources.ap_ \
    -I $ANDROID_HOME/platforms/android-29/android.jar \
    --manifest build/intermediates/manifests/full/debug/AndroidManifest.xml \
    build/layout_activity_main.xml.flat \
    build/values_styles.arsc.flat \
    build/values_colors.arsc.flat \
    build/values_strings.arsc.flat \
    build/mipmap-xxxhdpi_ic_launcher.png.flat \
    build/mipmap-xxxhdpi_ic_launcher_round.png.flat
```

## AAPT2 ÂÆπÂô®Ê†ºÂºè

Âú® *AAPT2* ÁöÑÁºñËØëÈò∂ÊÆµÔºå‰ºöÁîüÊàêÊâ©Â±ïÂêç‰∏∫ *.flat* ÁöÑ‰∏≠Èó¥‰∫åËøõÂà∂Êñá‰ª∂ÔºåËøôÁßç‰ª• *.flat* ‰Ωú‰∏∫Êâ©Â±ïÂêçÁöÑÊñá‰ª∂Ê†ºÂºèÔºåË¢´Áß∞‰πã‰∏∫ *AAPT2* ÂÆπÂô®Ôºå*AAPT2* ÂÆπÂô®Êñá‰ª∂Áî±Êñá‰ª∂Â§¥ÂíåËµÑÊ∫êÈ°π‰∏§Â§ßÈÉ®ÂàÜÁªÑÊàêÔºåÂÆπÂô®‰∏≠ÁöÑÂêÑ‰∏™Â≠óÊÆµ‰ª•Â∞èÁ´ØÔºà*Little-Endian*ÔºâÂ≠óËäÇÂ∫èË°®Á§∫Ôºö

### AAPT2 Êñá‰ª∂Â§¥

| Â≠óÊÆµ          | Â≠óËäÇÊï∞ | ÊèèËø∞                                                      |
|---------------|:------:|-----------------------------------------------------------|
| `magic`       | 4      | *AAPT2* ÂÆπÂô®Êñá‰ª∂Ê†áËØÜÔºö`AAPT` Êàñ `0x54504141`              |
| `version`     | 4      | *AAPT2* ÂÆπÂô®ÁâàÊú¨                                          |
| `entry_count` | 4      | ÂÆπÂô®‰∏≠ÂåÖÂê´ÁöÑÊù°ÁõÆÊï∞Ôºà‰∏Ä‰∏™ *flat* Êñá‰ª∂‰∏≠ÂèØ‰ª•ÂåÖÂê´Â§ö‰∏™ËµÑÊ∫êÈ°πÔºâ|

### AAPT2 ËµÑÊ∫êÈ°π

| Â≠óÊÆµ          | Â≠óËäÇÊï∞         | ÊèèËø∞                                                                              |
|---------------|:--------------:|-----------------------------------------------------------------------------------|
| `entry_type`  | 4              | ËµÑÊ∫êÁ±ªÂûãÔºàÁõÆÂâç‰ªÖÊîØÊåÅ‰∏§ÁßçÁ±ªÂûãÔºö`RES_TABLE(0x00000000)` Êàñ `RES_FILE (0x00000001)`Ôºâ|
| `entry_length`| 8              | ËµÑÊ∫êÊï∞ÊçÆÈïøÂ∫¶                                                                      |
| `data`        | `entry_length` | ËµÑÊ∫êÊï∞ÊçÆ                                                                          |

#### Resource Table

ÂΩì `entry_type`‰∏∫ `0x00000000` Êó∂Ôºå`data` Ë°®Á§∫ *protobuf* Â∫èÂàóÂåñÁöÑ [ResourceTable](https://github.com/aosp-mirror/platform_frameworks_base/blob/master/tools/aapt2/Resources.proto) ÁªìÊûÑ

#### Resource File

ÂΩì `entry_type`‰∏∫ `0x00000001` Êó∂Ôºå`data` Ë°®Á§∫ËµÑÊ∫êÊñá‰ª∂ÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö

| Â≠óÊÆµ             | Â≠óËäÇÊï∞        | ÊèèËø∞                                                                                                                                                                        |
|------------------|:-------------:|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `header_size`    | 4             | `header` ÁöÑÈïøÂ∫¶                                                                                                                                                             |
| `data_size`      | 8             | `data` ÁöÑÈïøÂ∫¶                                                                                                                                                               |
| `header`         | `header_size` | Ë°®Á§∫ *protobuf* Â∫èÂàóÂåñÁöÑ [CompiledFile](https://github.com/aosp-mirror/platform_frameworks_base/blob/master/tools/aapt2/ResourcesInternal.proto) ÁªìÊûÑ                       |
| `header_padding` | `x`           | *0-3* ‰∏™Â°´ÂÖÖÂ≠óËäÇÔºåÁî®‰∫é `data` 32 ‰ΩçÂØπÈΩê                                                                                                                                 |
| `data`           | `data_size`   | ËµÑÊ∫êÊñá‰ª∂ÂÜÖÂÆπÔºà*PNG*, ‰∫åËøõÂà∂ *XML* ÊàñËÄÖ *protobuf* Â∫èÂàóÂåñÁöÑ [XmlNode](https://github.com/aosp-mirror/platform_frameworks_base/blob/master/tools/aapt2/Resources.proto) ÁªìÊûÑÔºâ|
| `data_padding`   | `y`           | *0-3* ‰∏™Â°´ÂÖÖÂ≠óËäÇÔºåÁî®‰∫é `data` 32 ‰ΩçÂØπÈΩê                                                                                                                                        |

> AAPT2 Ê†ºÂºèËßÑËåÉÔºöhttps://github.com/aosp-mirror/platform_frameworks_base/blob/master/tools/aapt2/formats.md

### *flat* Ê†ºÂºèÁöÑÂÖºÂÆπÊÄßÈóÆÈ¢ò

ËôΩÁÑ∂ *Android Gradle Plugin 3.0.0* Â∑≤ÁªèÈªòËÆ§ÂêØÁî® *AAPT2*Ôºå‰ΩÜÊòØ *AAPT2* ÁöÑ‰∫ßÂá∫Áâ©Ôºà*flat* Êñá‰ª∂ÔºâÁöÑÊ†ºÂºèÁõ¥Âà∞ *Android Gradle Plugin 3.2.0* ÊâçÁ®≥ÂÆö‰∏ãÊù•ÔºåÈÇ£ *3.2.0* ‰ª•ÂâçÁöÑÁâàÊú¨‰∫ßÂá∫ÁöÑ *flat* Êñá‰ª∂Ê†ºÂºèÂà∞Â∫ïÊòØ‰ªÄ‰πàÊ†∑Â≠êÂë¢Ôºü

#### Resource File

ÈÄöËøáÈÄÜÂêëÂàÜÊûê *flat* Êñá‰ª∂ÔºåÊàë‰ª¨ËøòÂéü‰∫Ü *Android Gradle Plugin 3.2.0* ‰ª•ÂâçÁöÑÁâàÊú¨‰∫ßÂá∫ÁöÑ *flat* Êñá‰ª∂Ê†ºÂºèÔºåÂ¶Ç‰∏ãË°®ÊâÄÁ§∫Ôºö

| Â≠óÊÆµ             | Â≠óËäÇÊï∞         | ÊèèËø∞                                                                                                                                                |
|------------------|:--------------:|-----------------------------------------------------------------------------------------------------------------------------------------------------|
| `entry_type`     | 4              | ËµÑÊ∫êÁ±ªÂûãÔºàÈÄöÂ∏∏‰∏∫Ôºö`RES_FILE (0x00000001)`Ôºâ                                                                                                         |
| `entry_length`   | 8              | ËµÑÊ∫êÊï∞ÊçÆÈïøÂ∫¶                                                                                                                                        |
| `header`         | `header_size`  | Ë°®Á§∫ *protobuf* Â∫èÂàóÂåñÁöÑ [CompiledFile](https://github.com/didi/booster/blob/master/booster-aapt2/src/main/proto/ResourcesInternalLegacy.proto#L20) |
| `header_padding` | `x`            | *0-3* ‰∏™Â°´ÂÖÖÂ≠óËäÇÔºåÁî®‰∫é `data` 32 ‰ΩçÂØπÈΩê                                                                                                             |
| `data`           | `entry_length` | ËµÑÊ∫êÊï∞ÊçÆ                                                                                                                                            |
| `data_padding`   | `y`            | *0-3* ‰∏™Â°´ÂÖÖÂ≠óËäÇÔºåÁî®‰∫é `data` 32 ‰ΩçÂØπÈΩê                                                                                                             |
#### Resource Table

*Resource Table* ÁöÑÊ†ºÂºèÊØîËæÉÁÆÄÂçïÔºåÂÖ∂ÂÆûÂ∞±ÊòØ [ResourceTable](https://github.com/aosp-mirror/platform_frameworks_base/blob/0c80895c203640148da94bf04a57f1965a1c0d3d/tools/aapt2/Format.proto#L69) ÁöÑ *protobuf* Â∫èÂàóÂåñÁªìÊûú„ÄÇ

> ÂÖ≥‰∫é‰∫åËøõÂà∂Êñá‰ª∂ÁöÑÈÄÜÂêëÂ∑•ÂÖ∑ÔºåÁ±ª *Linux* Á≥ªÁªüÈÉΩËá™Â∏¶ *xxd* ÂëΩ‰ª§ÔºåÂèØ‰ª•Áõ¥Êé•ËæìÂá∫‰∫åËøõÂà∂Êñá‰ª∂ÁöÑÂçÅÂÖ≠ËøõÂà∂Ê†ºÂºèÔºö
>
> ```bash
> $ xxd ./build/intermediates/res/merged/debug/mipmap-hdpi_ic_launcher.png.flat
> ```
>
> ÊàñËÄÖ‰ΩøÁî® *VIM* ÊâìÂºÄ‰∫åËøõÂà∂Êñá‰ª∂
>
> ```bash
> $ vim ./build/intermediates/res/merged/debug/mipmap-hdpi_ic_launcher.png.flat
> ```
>
> ÁÑ∂ÂêéÂú® *VIM* ‰∏≠ËæìÂÖ•Ôºö
>
> ```vim
> :%!xxd
> ```

## *flat* ‰∏é *AAPT* ‰∫ßÁâ©ÁöÑÂÖ≥Á≥ª

Âú® *Android Gradle Plugin 3.0* ‰ª•ÂâçÁöÑÁâàÊú¨‰∏≠Ôºå*AAPT* ÁöÑ‰∫ßÁâ©‰∏ªË¶ÅÊúâ *3* Á±ªÔºö

1. Â∑≤ÁºñËØëÁöÑ‰∫åËøõÂà∂ XMLÔºå‰æãÂ¶ÇÔºöÂ∏ÉÂ±Ä *XML* Êñá‰ª∂Ôºõ
1. Â≠óÁ¨¶‰∏≤Ê±†Ôºà*String Pool*ÔºâÔºåÂÜÖÂµå‰∫é *Resource Table* ‰∏≠Ôºå‰∏ÄËà¨‰∏ç‰ºöÁã¨Á´ãÂ≠òÂú®Ôºõ
1. ËµÑÊ∫êË°®Ôºà*Resource Table*ÔºâÔºå‰æãÂ¶ÇÔºö*ARSC* Êñá‰ª∂Ôºõ

*AAPT2* ÁöÑÂ§ßÈÉ®ÂàÜÊï∞ÊçÆÁªìÊûÑÈÉΩÈááÁî® *protobuf* ÈáçÊñ∞ËøõË°åÁºñÁ†ÅÔºå‰ΩÜËøòÊúâ‰∏ÄÂ∞èÈÉ®ÂàÜÊï∞ÊçÆÁªìÊûÑ‰ªçÁÑ∂Â§çÁî®‰∫Ü*AAPT* ÁöÑÊ†ºÂºèÔºå‰æãÂ¶ÇÔºö*String Pool* ÔºåÊàë‰ª¨‰ªé *AAPT2* ÁöÑ *proto* ÂÆö‰πâ‰æøÂèØ‰ª•ÁúãÂá∫Êù•Ôºö

```protobuf
message StringPool {
  bytes data = 1;
}

message ResourceTable {
  // The string pool containing source paths referenced throughout the resource table. This does
  // not end up in the final binary ARSC file.
  StringPool source_pool = 1;

  // Resource definitions corresponding to an Android package.
  repeated Package package = 2;
}
```

## *AAPT2* ÂÆπÂô®ÁöÑÊÑè‰πâ

*AAPT2* ‰∏∫‰ªÄ‰πàË¶ÅÂ∞Ü‰∏≠Èó¥‰∫ßÁâ©ÁºñÁ†ÅÊàê *flat* Ê†ºÂºèÂë¢Ôºü‰∏ªË¶ÅÂéüÂõ†Âú®‰∫é *AAPT2* Â∞ÜËµÑÊ∫êÊâìÂåÖËøáÁ®ãÊãÜÂàÜÊàê‰∫Ü‰∏§‰∏™Èò∂ÊÆµÔºö„ÄåÁºñËØëÈò∂ÊÆµ„ÄçÂíå„ÄåÈìæÊé•Èò∂ÊÆµ„ÄçÔºå‰∏∫‰∫ÜÂú®ÈìæÊé•Èò∂ÊÆµÂæóÂà∞ËµÑÊ∫êÊõ¥ËØ¶ÁªÜÁöÑ‰ø°ÊÅØÔºå‰æãÂ¶ÇÔºöËµÑÊ∫êÂêçÁß∞„ÄÅÈÖçÁΩÆ‰ø°ÊÅØÔºà*Configuration*Ôºâ Á≠âÔºåÂõ†Ê≠§ÔºåÁõ¥Êé•Â∞ÜËµÑÊ∫êÁöÑÂÖÉ‰ø°ÊÅØËøûÂêåËµÑÊ∫êÊú¨Ë∫´‰∏ÄÂêåÁºñÁ†ÅËøõ *AAPT2* ÂÆπÂô®Êñá‰ª∂‰∏≠ÔºåËøôÊ†∑ÔºåËµÑÊ∫êÈìæÊé•ÁöÑËøáÁ®ãÂèØ‰ª•ÂÆåÂÖ®‰∏éÁºñËØëËøáÁ®ãËß£ËÄ¶‰∫ÜÔºåËÄå‰∏îÔºåÂØπ‰∫éÂ¢ûÈáèÊûÑÂª∫Êù•ËØ¥ÔºåËøôÊ†∑Â§ßÂ§ßÊèêÂçá‰∫ÜËµÑÊ∫êÊâìÂåÖÁöÑÊÄßËÉΩ„ÄÇ

## Âú® *Gradle* Êèí‰ª∂‰∏≠ËÆøÈóÆ *aapt2*

### *AGP 3.5.0* ‰ª•‰∏ãÁâàÊú¨

```kotlin
fun findAapt2(project: Project) {
    project.applicationVariants.forEach { variant ->
        val variantImpl = variant as ApplicationVariantImpl;
        val buildTool = variantImpl.variantData.scope.globalScope.androidBuilder.buildToolInfo;
        val aapt2 = buildTool.getPath(BuildToolInfo.PathId.AAPT2);
        // do something with aapt2
    }
}
```

### *AGP 3.5.0* ‰ª•‰∏äÁâàÊú¨

```kotlin
fun findAapt2(project: Project) {
    project.applicationVariants.forEach { variant ->
        val variantImpl = variant as ApplicationVariantImpl;
        val buildTool = variantImpl.variantData.scope.globalScope.androidBuilder.buildToolInfoProvider.get();
        val aapt2 = buildTool.getPath(BuildToolInfo.PathId.AAPT2);
        // do something with aapt2
    }
}
```

## Âú®‰ª£Á†Å‰∏≠ÊâßË°å *aapt2* ÂëΩ‰ª§

```kotlin
fun runAapt2(project: Project, aapt2: String, args: List<String>) {
    val rc = project.exec { spec ->
        spec.isIgnoreExitValue = true
        spec.commandLine = listOf(aapt2) + args
    }

    when (rc.exitValue) {
        0 -> println("Aapt2 execute successful")
        else -> println("Aapt2 execute failed: ${rc.exitValue}")
    }
}
```

## Booster Aapt2

‰∏∫‰∫Ü‰æø‰∫éÂú® *Gradle* Êèí‰ª∂‰∏≠Ëß£Êûê *flat* Êñá‰ª∂Ôºå*Booster* Êèê‰æõ‰∫Ü [booster-aapt2](https://github.com/didi/booster/tree/master/booster-aapt2) Ê®°ÂùóÔºåÊèê‰æõ‰∫Ü [BinaryParser](https://github.com/didi/booster/blob/master/booster-aapt2/src/main/kotlin/com/didiglobal/booster/aapt2/BinaryParser.kt) ‰ª•Âèä [Aapt2Parser](https://github.com/didi/booster/blob/master/booster-aapt2/src/main/kotlin/com/didiglobal/booster/aapt2/Aapt2Parser.kt) Êù•Ëß£ÊûêÂ∑≤ÁºñËØëÁöÑËµÑÊ∫êÔºåÁî±‰∫é *Android Gradle Plugin* ÁâàÊú¨Èó¥Â≠òÂú®Â∑ÆÂºÇÂØºËá¥ *AAPT2* ‰∏≠Èó¥‰∫ßÁâ©Ê†ºÂºè‰∏ç‰∏ÄËá¥ÔºåËÄå [booster-aapt2](https://github.com/didi/booster/tree/master/booster-aapt2) Â±èËîΩ‰∫ÜËøô‰∫õÁªÜÂæÆÁöÑÂ∑ÆÂºÇÔºå‰ª•ÁÆÄÂåñÂ∑≤ÁºñËØëËµÑÊ∫êÊñá‰ª∂ÁöÑËß£ÊûêËøáÁ®ã„ÄÇ

### ‰ΩøÁî®ÊñπÊ≥ï

Âú® *build.gradle* ‰∏≠ÂºïÂÖ• [booster-aapt2](https://github.com/didi/booster/tree/master/booster-aapt2) ‰æùËµñÔºåÂ¶Ç‰∏ãÊâÄÁ§∫Ôºö

```groovy
buildscript {
    ext {
        kotlin_version = '1.3.31'
        booster_version = '4.4.0'
    }
    repositories {
        mavenLocal()
        mavenCentral()
        google()
        jcenter()
        maven { url 'https://oss.sonatype.org/content/repositories/public/' }
        maven { url 'https://oss.sonatype.org/content/repositories/snapshots/' }
    }
    dependencies {
        classpath 'com.android.tools.build:gradle:3.5.0'
        classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version"

        /* üëáüëáüëáüëá ÂºïÁî®Ëøô‰∏™Ê®°Âùó üëáüëáüëáüëá */
        classpath "com.didiglobal.booster:booster-aapt2:$booster_version"
    }
}
```

ÁÑ∂ÂêéÔºåÈÄöËøá [BinaryParser](https://github.com/didi/booster/blob/master/booster-aapt2/src/main/kotlin/com/didiglobal/booster/aapt2/BinaryParser.kt) Âíå [Aapt2Parser](https://github.com/didi/booster/blob/master/booster-aapt2/src/main/kotlin/com/didiglobal/booster/aapt2/Aapt2Parser.kt) Êù•Ëß£ÊûêÂ∑≤ÁºñËØëÁöÑËµÑÊ∫êÊñá‰ª∂Ôºö

```kotlin
fun parseCompiledResource(res: File) {
    val container = BinaryParser(res).use { parser ->
        parser.parseAapt2Container()
    }

    container.entries.map {
        it as Aapt2Container.ResFile
    }.forEach { res ->
        // do something with parsed resource
    }
}
```
