import{r as o,o as c,c as d,a as e,b as s,d as a,w as r,F as p,e as n}from"./app.9958f85a.js";import{_ as h}from"./plugin-vue_export-helper.21dcd24c.js";const b={},u=n('<h1 id="static-analysis" tabindex="-1"><a class="header-anchor" href="#static-analysis" aria-hidden="true">#</a> Static Analysis</h1><h2 id="what-can-static-analysis-do" tabindex="-1"><a class="header-anchor" href="#what-can-static-analysis-do" aria-hidden="true">#</a> What Can Static Analysis Do?</h2><p>After a lot of practice, we have found that many problems can actually be detected before the product is released or launched. However, due to the lack of corresponding tools, many problems are hidden and brought to production until they encountered by customers. such as UI jank, crash, security issues, etc. Through static analysis, we can detect these potential issues and risks as early as possible and fix them before release, this is the original intention of the Booster project.</p><h2 id="why-not-sonarqube" tabindex="-1"><a class="header-anchor" href="#why-not-sonarqube" aria-hidden="true">#</a> Why not SonarQube?</h2><p>SonarQube is a famous source code oriented analysis tools, it doesn&#39;t support analysis byte code generated by compilers, due the limitation of source code based analysis, Booster was born for bytecode oriented static analysing.</p><h2 id="what-problems-does-booster-s-static-analysis-solve" tabindex="-1"><a class="header-anchor" href="#what-problems-does-booster-s-static-analysis-solve" aria-hidden="true">#</a> What Problems does Booster&#39;s Static Analysis Solve?</h2>',6),m={href:"https://github.com/didi/booster/tree/master/booster-task-analyser",target:"_blank",rel:"noopener noreferrer"},f=n('<ol><li>Detecting potential performance issues, such as: API calls that may block or slow down the main/UI thread.</li><li>Detecting risky API calls</li><li>Analysing class dependencies</li></ol><h2 id="what-s-the-solution" tabindex="-1"><a class="header-anchor" href="#what-s-the-solution" aria-hidden="true">#</a> What&#39;s the Solution?</h2><h3 id="standalone-task" tabindex="-1"><a class="header-anchor" href="#standalone-task" aria-hidden="true">#</a> Standalone Task</h3><p>Booster&#39;s static analysis is based on an independent task but not a transformer, the reason for this design is mainly based on the following considerations:</p><ol><li>The frequency of static analsysis of the application might not as frequent as build, so a task is more suitable than a transformer.</li><li>The <em>CHA (Class Hierarchy Analysis)</em> need to get all class information, and the transformer is based on pipeline processing, which is not suitable for static analysis.</li><li>The static analysis might take a long time, as a transformer, it will slow down the build process, and the app build doesn&#39;t depend on the analysis result.</li></ol><p>The following figure shown the dependency of <em>Analyser Task</em>:</p><svg width="514pt" height="188pt" viewBox="0.00 0.00 513.51 188.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 184)"><title>analyser</title><polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-184 509.5063,-184 509.5063,4 -4,4"></polygon><g id="node1" class="node"><title>analyse</title><polygon fill="#f18f01" stroke="transparent" points="281.4639,-180 216.9891,-180 216.9891,-144 281.4639,-144 281.4639,-180"></polygon><text text-anchor="middle" x="249.2265" y="-157.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#ffffff">analyse</text></g><g id="node2" class="node"><title>analyseDebug</title><polygon fill="#006e90" stroke="transparent" points="238.2016,-108 132.2514,-108 132.2514,-72 238.2016,-72 238.2016,-108"></polygon><text text-anchor="middle" x="185.2265" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#ffffff">analyseDebug</text></g><g id="edge1" class="edge"><title>analyse-&gt;analyseDebug</title><path fill="none" stroke="#555555" d="M233.0766,-143.8314C225.5548,-135.3694 216.47,-125.1489 208.2461,-115.8971"></path><polygon fill="#555555" stroke="#555555" points="210.8535,-113.5621 201.5938,-108.4133 205.6216,-118.2127 210.8535,-113.5621"></polygon></g><g id="node3" class="node"><title>analyseRelease</title><polygon fill="#006e90" stroke="transparent" points="404.8079,-108 289.6451,-108 289.6451,-72 404.8079,-72 404.8079,-108"></polygon><text text-anchor="middle" x="347.2265" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#ffffff">analyseRelease</text></g><g id="edge2" class="edge"><title>analyse-&gt;analyseRelease</title><path fill="none" stroke="#555555" d="M273.956,-143.8314C286.1427,-134.8779 301.0088,-123.9558 314.1577,-114.2955"></path><polygon fill="#555555" stroke="#555555" points="316.5183,-116.9042 322.5049,-108.1628 312.3738,-111.263 316.5183,-116.9042"></polygon></g><g id="node4" class="node"><title>transformClassesWithXxxForDebug</title><polygon fill="#99c24d" stroke="transparent" points="238.6799,-36 -.2269,-36 -.2269,0 238.6799,0 238.6799,-36"></polygon><text text-anchor="middle" x="119.2265" y="-13.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#ffffff">transformClassesWithXxxForDebug</text></g><g id="edge3" class="edge"><title>analyseDebug-&gt;transformClassesWithXxxForDebug</title><path fill="none" stroke="#555555" d="M168.5719,-71.8314C160.8151,-63.3694 151.4463,-53.1489 142.9655,-43.8971"></path><polygon fill="#555555" stroke="#555555" points="145.4427,-41.4198 136.1053,-36.4133 140.2826,-46.1499 145.4427,-41.4198"></polygon></g><g id="node5" class="node"><title>transformClassesWithXxxForRelease</title><polygon fill="#99c24d" stroke="transparent" points="505.2865,-36 257.1665,-36 257.1665,0 505.2865,0 505.2865,-36"></polygon><text text-anchor="middle" x="381.2265" y="-13.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#ffffff">transformClassesWithXxxForRelease</text></g><g id="edge4" class="edge"><title>analyseRelease-&gt;transformClassesWithXxxForRelease</title><path fill="none" stroke="#555555" d="M355.8061,-71.8314C359.5623,-63.8771 364.0522,-54.369 368.2063,-45.5723"></path><polygon fill="#555555" stroke="#555555" points="371.4261,-46.9503 372.5313,-36.4133 365.0964,-43.9612 371.4261,-46.9503"></polygon></g></g></svg><h3 id="class-hierarchy-analysis" tabindex="-1"><a class="header-anchor" href="#class-hierarchy-analysis" aria-hidden="true">#</a> Class Hierarchy Analysis</h3><p>The CHA (Class Hierarchy Analysis) is very important for static analysis, it determines the accuracy of the analysis results.</p>',9),g=e("code",null,"ClassLoader",-1),y={href:"https://github.com/didi/booster/blob/master/booster-transform-spi/src/main/kotlin/com/didiglobal/booster/transform/KlassPool.kt",target:"_blank",rel:"noopener noreferrer"},k={href:"https://github.com/didi/booster/blob/master/booster-transform-spi/src/main/kotlin/com/didiglobal/booster/transform/Klass.kt",target:"_blank",rel:"noopener noreferrer"},_={href:"https://github.com/didi/booster/tree/master/booster-task-analyser",target:"_blank",rel:"noopener noreferrer"},v={href:"https://github.com/didi/booster/blob/master/booster-cha/src/main/kotlin/com/didiglobal/booster/cha/ClassFileParser.kt",target:"_blank",rel:"noopener noreferrer"},x=n('<p>Why there are two implementations of CHA? the main reasons are as follows:</p><ol><li>When <code>ClassLoader</code> load a class, although it is not necessary to initialize the class, the <code>ClassLoader</code> will verify the bytecode and may throw a <code>VerifyError</code> which will cause the entire analysis process to fail.</li><li>Overhead performance \u2014\u2014 The performance of loading class by <code>ClassLoader</code> is far from <em>ASM</em>.</li><li>In addition to analyzing the inheritance relationship of the classes, it&#39;s also necessary to analyze the fields, methodand annotations, and obtaining information from class by reflection has some limitation, such as runtime-invisible annotations, it&#39;s impossible to reflect they from <code>Class</code>.</li><li>Compared with transformer, task can be executed independently, if all classes are loaded in the process of Transform, it may cause memory constraints and even OOM.</li></ol><h3 id="the-entry-points-for-analysing" tabindex="-1"><a class="header-anchor" href="#the-entry-points-for-analysing" aria-hidden="true">#</a> The Entry Points for Analysing</h3><p>To analyse an application, the static analyser requires an entry point, for general programs, the <code>main</code> method is the entry point, for Android applications, the <code>Application</code>, <code>Activity</code>, <code>Service</code>, <code>Broadcast</code> and <code>Provider</code> are the entry points, so, the first thing is locating these entry points.</p><h4 id="android-components" tabindex="-1"><a class="header-anchor" href="#android-components" aria-hidden="true">#</a> Android Components</h4>',5),w=e("code",null,"Application",-1),A=e("code",null,"Activity",-1),C=e("code",null,"Service",-1),T=e("code",null,"Broadcast",-1),P=e("code",null,"Provider",-1),S=e("em",null,"AndroidManifest.xml",-1),B=e("em",null,"AndroidManifest.xml",-1),H={href:"https://github.com/didi/booster/blob/master/booster-android-gradle-api/src/main/kotlin/com/didiglobal/booster/gradle/BaseVariant.kt#L150",target:"_blank",rel:"noopener noreferrer"},I=e("h4",{id:"custom-views",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#custom-views","aria-hidden":"true"},"#"),s(" Custom Views")],-1),M={href:"https://github.com/didi/booster/blob/master/booster-android-gradle-api/src/main/kotlin/com/didiglobal/booster/gradle/BaseVariant.kt#L158",target:"_blank",rel:"noopener noreferrer"},D={href:"https://github.com/aosp-mirror/platform_frameworks_base/blob/master/tools/aapt2/formats.md",target:"_blank",rel:"noopener noreferrer"},W={href:"https://developer.android.com/studio/command-line/aapt2",target:"_blank",rel:"noopener noreferrer"},F={href:"https://github.com/didi/booster/tree/master/booster-aapt2",target:"_blank",rel:"noopener noreferrer"},L=e("blockquote",null,[e("p",null,"According to the benchmark test, we have found that parsing AAPT2 container file is not as efficient as parsing the XML source file, so, the final implementation is a combination of two solutions -- parsing the AAPT container file header by AAPT2 container parser first, and then get the source XML from the file header.")],-1),z=e("h4",{id:"methods-and-classes-annotated-with-thread-annotations",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#methods-and-classes-annotated-with-thread-annotations","aria-hidden":"true"},"#"),s(" Methods and Classes Annotated with Thread Annotations")],-1),R={href:"https://developer.android.com/studio/write/annotations#thread-annotations",target:"_blank",rel:"noopener noreferrer"},G={href:"https://developer.android.com/studio/write/annotations#thread-annotations",target:"_blank",rel:"noopener noreferrer"},V={href:"https://github.com/greenrobot/EventBus",target:"_blank",rel:"noopener noreferrer"},X={href:"https://github.com/didi/booster/tree/master/booster-task-analyser",target:"_blank",rel:"noopener noreferrer"},q=e("code",null,"@Subscribe(threadMode = MAIN)",-1),E=e("h2",{id:"getting-started",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#getting-started","aria-hidden":"true"},"#"),s(" Getting Started")],-1),U={href:"https://github.com/didi/booster/tree/master/booster-task-analyser",target:"_blank",rel:"noopener noreferrer"},$=e("div",{class:"language-groovy ext-groovy line-numbers-mode"},[e("pre",{class:"language-groovy"},[e("code",null,[s("buildscript "),e("span",{class:"token punctuation"},"{"),s(`
    ext`),e("span",{class:"token punctuation"},"."),s("booster_version "),e("span",{class:"token operator"},"="),s(),e("span",{class:"token interpolation-string"},[e("span",{class:"token string"},'"4.16.3"')]),s(`

    dependencies `),e("span",{class:"token punctuation"},"{"),s(`
        classpath `),e("span",{class:"token interpolation-string"},[e("span",{class:"token string"},'"com.didiglobal.booster:booster-gradle-plugin:'),e("span",{class:"token interpolation"},[e("span",{class:"token interpolation-punctuation punctuation"},"$"),e("span",{class:"token expression"},"booster_version")]),e("span",{class:"token string"},'"')]),s(`
        classpath `),e("span",{class:"token interpolation-string"},[e("span",{class:"token string"},'"com.didiglobal.booster:booster-task-analyser:'),e("span",{class:"token interpolation"},[e("span",{class:"token interpolation-punctuation punctuation"},"$"),e("span",{class:"token expression"},"booster_version")]),e("span",{class:"token string"},'"')]),s(`
    `),e("span",{class:"token punctuation"},"}"),s(`
`),e("span",{class:"token punctuation"},"}"),s(`
`)])]),e("div",{class:"line-numbers"},[e("span",{class:"line-number"},"1"),e("br"),e("span",{class:"line-number"},"2"),e("br"),e("span",{class:"line-number"},"3"),e("br"),e("span",{class:"line-number"},"4"),e("br"),e("span",{class:"line-number"},"5"),e("br"),e("span",{class:"line-number"},"6"),e("br"),e("span",{class:"line-number"},"7"),e("br"),e("span",{class:"line-number"},"8"),e("br")])],-1),K=e("div",{class:"language-kotlin ext-kt line-numbers-mode"},[e("pre",{class:"language-kotlin"},[e("code",null,[s("buildscript "),e("span",{class:"token punctuation"},"{"),s(`
    `),e("span",{class:"token keyword"},"val"),s(" booster_version "),e("span",{class:"token operator"},"="),s(),e("span",{class:"token string-literal singleline"},[e("span",{class:"token string"},'"4.16.3"')]),s(`

    dependencies `),e("span",{class:"token punctuation"},"{"),s(`
        `),e("span",{class:"token function"},"classpath"),e("span",{class:"token punctuation"},"("),e("span",{class:"token string-literal singleline"},[e("span",{class:"token string"},'"com.didiglobal.booster:booster-gradle-plugin:'),e("span",{class:"token interpolation"},[e("span",{class:"token interpolation-punctuation punctuation"},"$"),e("span",{class:"token expression"},"booster_version")]),e("span",{class:"token string"},'"')]),e("span",{class:"token punctuation"},")"),s(`
        `),e("span",{class:"token function"},"classpath"),e("span",{class:"token punctuation"},"("),e("span",{class:"token string-literal singleline"},[e("span",{class:"token string"},'"com.didiglobal.booster:booster-task-analyser:'),e("span",{class:"token interpolation"},[e("span",{class:"token interpolation-punctuation punctuation"},"$"),e("span",{class:"token expression"},"booster_version")]),e("span",{class:"token string"},'"')]),e("span",{class:"token punctuation"},")"),s(`
    `),e("span",{class:"token punctuation"},"}"),s(`
`),e("span",{class:"token punctuation"},"}"),s(`
`)])]),e("div",{class:"line-numbers"},[e("span",{class:"line-number"},"1"),e("br"),e("span",{class:"line-number"},"2"),e("br"),e("span",{class:"line-number"},"3"),e("br"),e("span",{class:"line-number"},"4"),e("br"),e("span",{class:"line-number"},"5"),e("br"),e("span",{class:"line-number"},"6"),e("br"),e("span",{class:"line-number"},"7"),e("br"),e("span",{class:"line-number"},"8"),e("br")])],-1),j=e("p",null,[s("Then, execute the "),e("em",null,"analyse"),s(" task by command line:")],-1),N=e("div",{class:"language-bash ext-sh line-numbers-mode"},[e("pre",{class:"language-bash"},[e("code",null,`$ ./gradlew analyse
`)]),e("div",{class:"line-numbers"},[e("span",{class:"line-number"},"1"),e("br")])],-1),O=e("em",null,"build/reports/",-1),Q=e("em",null,".dot",-1),J=e("em",null,".png",-1),Y={href:"https://graphviz.org/",target:"_blank",rel:"noopener noreferrer"},Z=n(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">find</span> build/reports <span class="token parameter variable">-name</span> <span class="token string">&#39;*.dot&#39;</span> <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token parameter variable">-t</span> -I<span class="token punctuation">{</span><span class="token punctuation">}</span> dot <span class="token parameter variable">-O</span> <span class="token parameter variable">-Tpng</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h2 id="white-black-lists" tabindex="-1"><a class="header-anchor" href="#white-black-lists" aria-hidden="true">#</a> White/Black Lists</h2>`,2),ee={href:"https://github.com/didi/booster/blob/master/booster-task-analyser/src/main/resources/whitelist.txt",target:"_blank",rel:"noopener noreferrer"},se={href:"https://github.com/didi/booster/blob/master/booster-task-analyser/src/main/resources/blacklist.txt",target:"_blank",rel:"noopener noreferrer"},ae=n(`<h3 id="specify-white-black-lists-by-gradle-properties" tabindex="-1"><a class="header-anchor" href="#specify-white-black-lists-by-gradle-properties" aria-hidden="true">#</a> Specify white/black lists by <em>gradle.properties</em></h3><div class="language-properties ext-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">booster.task.analyser.whitelist</span><span class="token punctuation">=</span><span class="token value attr-value">file:///Users/booster/whitelist.txt</span>
<span class="token key attr-name">booster.task.analyser.blacklist</span><span class="token punctuation">=</span><span class="token value attr-value">file:///Users/booster/blacklist.txt</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="specify-white-black-lists-by-command-line" tabindex="-1"><a class="header-anchor" href="#specify-white-black-lists-by-command-line" aria-hidden="true">#</a> Specify white/black lists by command line</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ ./gradlew assembleDebug <span class="token punctuation">\\</span>
    <span class="token parameter variable">-Pbooster.task.analyser.whitelist</span><span class="token operator">=</span>file:///Users/booster/whitelist.txt <span class="token punctuation">\\</span>
    <span class="token parameter variable">-Pbooster.task.analyser.blacklist</span><span class="token operator">=</span>file:///Users/booster/blacklist.txt
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>The white/black list also can be a remote URL, for example:</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>./gradlew assembleDebug <span class="token punctuation">\\</span>
    <span class="token parameter variable">-Pbooster.task.analyser.whitelist</span><span class="token operator">=</span>https://booster.johnsonlee.io/analyser/whitelist.txt
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div>`,6);function te(ne,oe){const t=o("ExternalLinkIcon"),i=o("CodeGroupItem"),l=o("CodeGroup");return c(),d(p,null,[u,e("p",null,[e("a",m,[s("booster-task-analyser"),a(t)]),s(" analyse apps by generating the cal graph, and then generate a analysis report, it provides more insights to help developers improve the app quality continously, including but not limited to:")]),f,e("p",null,[s("In transform, CHA is implemented by using "),g,s(", which is easy and simple, about more details, please see "),e("a",y,[s("KlassPool"),a(t)]),s(" & "),e("a",k,[s("Klass"),a(t)]),s(", it is mainly to solve the problem of how to judge whether the two type have an inheritance relationship.")]),e("p",null,[s("However, the "),e("a",_,[s("booster-task-analyser"),a(t)]),s(" is implemented by loading all classes with "),e("a",v,[s("ClassFileParser"),a(t)]),s(".")]),x,e("p",null,[s("For "),w,s(", "),A,s(", "),C,s(", "),T,s(" and "),P,s(", they all registered in the "),S,s(", it's easy to get the final "),B,s(" through the "),e("a",H,[s("mergedManifests"),a(t)]),s(".")]),I,e("p",null,[s("The most straightforward way to list up all custom views is to parse the layout xmls, which can be obtained through the "),e("a",M,[s("mergeRes"),a(t)]),s(", it's just an "),e("a",D,[s("APC format (AAPT2 Container Format)"),a(t)]),s(" file produced by the "),e("a",W,[s("AAPT2"),a(t)]),s(" command-line tool, that's why "),e("a",F,[s("booster-aapt2"),a(t)]),s(" comes out.")]),L,z,e("p",null,[s("The Android SDK already provided the "),e("a",R,[s("Thread Annotations"),a(t)]),s(" to help the compiler and lint to improve the inspection accuracy. so, if a class or method annotated with the "),e("a",G,[s("Thread Annotations"),a(t)]),s(", then it can be considered as an entry point.")]),e("p",null,[s("Considering that some third-party frameworks also have their own thread annotations, such as "),e("a",V,[s("Event Bus"),a(t)]),s(" , so the "),e("a",X,[s("booster-task-analyser"),a(t)]),s(" supports it by treating the method annotated with "),q,s(" as an entry point.")]),E,e("p",null,[s("Putting the "),e("a",U,[s("booster-task-analyser"),a(t)]),s(" into the classpath of Gradle build script:")]),a(l,null,{default:r(()=>[a(i,{title:"Groovy",active:""},{default:r(()=>[$]),_:1}),a(i,{title:"Kotlin"},{default:r(()=>[K]),_:1})]),_:1}),j,N,e("p",null,[s("After the execution is successful, a dot format report will be generated in the "),O,s(" directory, the "),Q,s(" files can be converted to "),J,s(" format by using the dot command line tool provided by "),e("a",Y,[s("Graphviz"),a(t)]),s(":")]),Z,e("p",null,[s("The white list is used for API ignoring, and the black list is used for API highlighting, Booster already provided a default "),e("a",ee,[s("whiltelist.txt"),a(t)]),s(" and "),e("a",se,[s("blacklist.txt"),a(t)]),s(", these are came from the practical experience, it also supports customization.")]),ae],64)}var le=h(b,[["render",te]]);export{le as default};
