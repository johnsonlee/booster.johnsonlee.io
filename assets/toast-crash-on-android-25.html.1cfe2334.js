import{r as o,o as e,c,a as s,b as n,d as p,F as l,e as t}from"./app.9958f85a.js";import{_ as u}from"./plugin-vue_export-helper.21dcd24c.js";const i={},r=t(`<h1 id="android-7-1-toast-\u5D29\u6E83" tabindex="-1"><a class="header-anchor" href="#android-7-1-toast-\u5D29\u6E83" aria-hidden="true">#</a> Android 7.1 Toast \u5D29\u6E83</h1><p>\u76F8\u4FE1\u5F88\u591A <em>Android</em> \u5F00\u53D1\u8005\u90FD\u89C1\u8FC7\u50CF\u8FD9\u6837\u7684\u5D29\u6E83\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>android.view.WindowManager$BadTokenException: Unable to add window -- token android.os.BinderProxy@e2815e is not valid; is your activity running?
    at android.view.ViewRootImpl.setView(ViewRootImpl.java:679)
    at android.view.WindowManagerGlobal.addView(WindowManagerGlobal.java:342)
    at android.view.WindowManagerImpl.addView(WindowManagerImpl.java:93)
    at android.widget.Toast$TN.handleShow(Toast.java:459)
    at android.widget.Toast$TN$2.handleMessage(Toast.java:342)
    at android.os.Handler.dispatchMessage(Handler.java:102)
    at android.os.Looper.loop(Looper.java:154)
    at android.app.ActivityThread.main(ActivityThread.java:6119)
    at java.lang.reflect.Method.invoke(Native Method) 
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="\u6839\u672C\u539F\u56E0" tabindex="-1"><a class="header-anchor" href="#\u6839\u672C\u539F\u56E0" aria-hidden="true">#</a> \u6839\u672C\u539F\u56E0</h2><p>\u901A\u8FC7 <em>APM</em> \u5E73\u53F0\u5206\u6790\u53D1\u73B0\uFF0C\u8FD9\u4E2A\u95EE\u9898\u4EC5\u53D1\u751F\u5728 <em>Android 7.1 (API Level 25)</em> \u7248\u672C\uFF0C\u6240\u4EE5\u65AD\u5B9A\uFF0C\u8FD9\u662F <em>Android 7.1</em> \u7684\u7CFB\u7EDF bug\uFF0C\u901A\u8FC7\u67E5\u770B\u6E90\u7801\uFF0C\u6211\u4EEC\u53EF\u4EE5\u770B\u5230\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Toast</span> <span class="token punctuation">{</span>

    <span class="token keyword">final</span> <span class="token class-name">TN</span> mTN<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleShow</span><span class="token punctuation">(</span><span class="token class-name">IBinder</span> windowToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>localLOGV<span class="token punctuation">)</span> <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;HANDLE SHOW: &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">&quot; mView=&quot;</span> <span class="token operator">+</span> mView
                <span class="token operator">+</span> <span class="token string">&quot; mNextView=&quot;</span> <span class="token operator">+</span> mNextView<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mView <span class="token operator">!=</span> mNextView<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// remove the old view if necessary</span>
            <span class="token function">handleHide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mView <span class="token operator">=</span> mNextView<span class="token punctuation">;</span>
            <span class="token class-name">Context</span> context <span class="token operator">=</span> mView<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> packageName <span class="token operator">=</span> mView<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOpPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                context <span class="token operator">=</span> mView<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mWM <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">WindowManager</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">WINDOW_SERVICE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// We can resolve the Gravity here by using the Locale for getting</span>
            <span class="token comment">// the layout direction</span>
            <span class="token keyword">final</span> <span class="token class-name">Configuration</span> config <span class="token operator">=</span> mView<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> gravity <span class="token operator">=</span> <span class="token class-name">Gravity</span><span class="token punctuation">.</span><span class="token function">getAbsoluteGravity</span><span class="token punctuation">(</span>mGravity<span class="token punctuation">,</span> config<span class="token punctuation">.</span><span class="token function">getLayoutDirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mParams<span class="token punctuation">.</span>gravity <span class="token operator">=</span> gravity<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>gravity <span class="token operator">&amp;</span> <span class="token class-name">Gravity</span><span class="token punctuation">.</span><span class="token constant">HORIZONTAL_GRAVITY_MASK</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Gravity</span><span class="token punctuation">.</span><span class="token constant">FILL_HORIZONTAL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mParams<span class="token punctuation">.</span>horizontalWeight <span class="token operator">=</span> <span class="token number">1.0f</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>gravity <span class="token operator">&amp;</span> <span class="token class-name">Gravity</span><span class="token punctuation">.</span><span class="token constant">VERTICAL_GRAVITY_MASK</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Gravity</span><span class="token punctuation">.</span><span class="token constant">FILL_VERTICAL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mParams<span class="token punctuation">.</span>verticalWeight <span class="token operator">=</span> <span class="token number">1.0f</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mParams<span class="token punctuation">.</span>x <span class="token operator">=</span> mX<span class="token punctuation">;</span>
            mParams<span class="token punctuation">.</span>y <span class="token operator">=</span> mY<span class="token punctuation">;</span>
            mParams<span class="token punctuation">.</span>verticalMargin <span class="token operator">=</span> mVerticalMargin<span class="token punctuation">;</span>
            mParams<span class="token punctuation">.</span>horizontalMargin <span class="token operator">=</span> mHorizontalMargin<span class="token punctuation">;</span>
            mParams<span class="token punctuation">.</span>packageName <span class="token operator">=</span> packageName<span class="token punctuation">;</span>
            mParams<span class="token punctuation">.</span>hideTimeoutMilliseconds <span class="token operator">=</span> mDuration <span class="token operator">==</span>
                <span class="token class-name">Toast</span><span class="token punctuation">.</span><span class="token constant">LENGTH_LONG</span> <span class="token operator">?</span> <span class="token constant">LONG_DURATION_TIMEOUT</span> <span class="token operator">:</span> <span class="token constant">SHORT_DURATION_TIMEOUT</span><span class="token punctuation">;</span>
            mParams<span class="token punctuation">.</span>token <span class="token operator">=</span> windowToken<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mView<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>localLOGV<span class="token punctuation">)</span> <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;REMOVE! &quot;</span> <span class="token operator">+</span> mView <span class="token operator">+</span> <span class="token string">&quot; in &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mWM<span class="token punctuation">.</span><span class="token function">removeView</span><span class="token punctuation">(</span>mView<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>localLOGV<span class="token punctuation">)</span> <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;ADD! &quot;</span> <span class="token operator">+</span> mView <span class="token operator">+</span> <span class="token string">&quot; in &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mWM<span class="token punctuation">.</span><span class="token function">addView</span><span class="token punctuation">(</span>mView<span class="token punctuation">,</span> mParams<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// \u{1F448}\u{1F448}\u{1F448}\u{1F448} \u5D29\u6E83\u53D1\u751F\u5728\u8FD9\u91CC</span>
            <span class="token function">trySendAccessibilityEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TN</span> <span class="token keyword">extends</span> <span class="token class-name">ITransientNotification<span class="token punctuation">.</span>Stub</span> <span class="token punctuation">{</span>

        <span class="token keyword">final</span> <span class="token class-name">Handler</span> mHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">case</span> <span class="token constant">SHOW</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token class-name">IBinder</span> token <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IBinder</span><span class="token punctuation">)</span> msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
                        <span class="token function">handleShow</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">case</span> <span class="token constant">HIDE</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token function">handleHide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// Don&#39;t do this in handleHide() because it is also invoked by handleShow()</span>
                        mNextView <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">case</span> <span class="token constant">CANCEL</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token function">handleHide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// Don&#39;t do this in handleHide() because it is also invoked by handleShow()</span>
                        mNextView <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cancelToast</span><span class="token punctuation">(</span>mPackageName<span class="token punctuation">,</span> <span class="token constant">TN</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br></div></div><h2 id="\u89E3\u51B3\u601D\u8DEF" tabindex="-1"><a class="header-anchor" href="#\u89E3\u51B3\u601D\u8DEF" aria-hidden="true">#</a> \u89E3\u51B3\u601D\u8DEF</h2><p>\u5728 <em>Android O (API Level 26)</em> \u6E90\u7801\u4E2D\uFF0C\u8FD9\u4E2A\u95EE\u9898\u5DF2\u7ECF\u88AB\u4FEE\u590D\u4E86\uFF0C\u4FEE\u590D\u65B9\u6CD5\u5C31\u662F\u7B80\u5355\u7C97\u66B4\u7684 <code>try-catch</code>\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Toast</span> <span class="token punctuation">{</span>

    <span class="token keyword">final</span> <span class="token class-name">TN</span> mTN<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleShow</span><span class="token punctuation">(</span><span class="token class-name">IBinder</span> windowToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>localLOGV<span class="token punctuation">)</span> <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;HANDLE SHOW: &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">&quot; mView=&quot;</span> <span class="token operator">+</span> mView
                <span class="token operator">+</span> <span class="token string">&quot; mNextView=&quot;</span> <span class="token operator">+</span> mNextView<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// If a cancel/hide is pending - no need to show - at this point</span>
        <span class="token comment">// the window token is already invalid and no need to do any work.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mHandler<span class="token punctuation">.</span><span class="token function">hasMessages</span><span class="token punctuation">(</span><span class="token constant">CANCEL</span><span class="token punctuation">)</span> <span class="token operator">||</span> mHandler<span class="token punctuation">.</span><span class="token function">hasMessages</span><span class="token punctuation">(</span><span class="token constant">HIDE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mView <span class="token operator">!=</span> mNextView<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// remove the old view if necessary</span>
            <span class="token function">handleHide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mView <span class="token operator">=</span> mNextView<span class="token punctuation">;</span>
            <span class="token class-name">Context</span> context <span class="token operator">=</span> mView<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> packageName <span class="token operator">=</span> mView<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOpPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                context <span class="token operator">=</span> mView<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mWM <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">WindowManager</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">WINDOW_SERVICE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// We can resolve the Gravity here by using the Locale for getting</span>
            <span class="token comment">// the layout direction</span>
            <span class="token keyword">final</span> <span class="token class-name">Configuration</span> config <span class="token operator">=</span> mView<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> gravity <span class="token operator">=</span> <span class="token class-name">Gravity</span><span class="token punctuation">.</span><span class="token function">getAbsoluteGravity</span><span class="token punctuation">(</span>mGravity<span class="token punctuation">,</span> config<span class="token punctuation">.</span><span class="token function">getLayoutDirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mParams<span class="token punctuation">.</span>gravity <span class="token operator">=</span> gravity<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>gravity <span class="token operator">&amp;</span> <span class="token class-name">Gravity</span><span class="token punctuation">.</span><span class="token constant">HORIZONTAL_GRAVITY_MASK</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Gravity</span><span class="token punctuation">.</span><span class="token constant">FILL_HORIZONTAL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mParams<span class="token punctuation">.</span>horizontalWeight <span class="token operator">=</span> <span class="token number">1.0f</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>gravity <span class="token operator">&amp;</span> <span class="token class-name">Gravity</span><span class="token punctuation">.</span><span class="token constant">VERTICAL_GRAVITY_MASK</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Gravity</span><span class="token punctuation">.</span><span class="token constant">FILL_VERTICAL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mParams<span class="token punctuation">.</span>verticalWeight <span class="token operator">=</span> <span class="token number">1.0f</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mParams<span class="token punctuation">.</span>x <span class="token operator">=</span> mX<span class="token punctuation">;</span>
            mParams<span class="token punctuation">.</span>y <span class="token operator">=</span> mY<span class="token punctuation">;</span>
            mParams<span class="token punctuation">.</span>verticalMargin <span class="token operator">=</span> mVerticalMargin<span class="token punctuation">;</span>
            mParams<span class="token punctuation">.</span>horizontalMargin <span class="token operator">=</span> mHorizontalMargin<span class="token punctuation">;</span>
            mParams<span class="token punctuation">.</span>packageName <span class="token operator">=</span> packageName<span class="token punctuation">;</span>
            mParams<span class="token punctuation">.</span>hideTimeoutMilliseconds <span class="token operator">=</span> mDuration <span class="token operator">==</span>
                <span class="token class-name">Toast</span><span class="token punctuation">.</span><span class="token constant">LENGTH_LONG</span> <span class="token operator">?</span> <span class="token constant">LONG_DURATION_TIMEOUT</span> <span class="token operator">:</span> <span class="token constant">SHORT_DURATION_TIMEOUT</span><span class="token punctuation">;</span>
            mParams<span class="token punctuation">.</span>token <span class="token operator">=</span> windowToken<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mView<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>localLOGV<span class="token punctuation">)</span> <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;REMOVE! &quot;</span> <span class="token operator">+</span> mView <span class="token operator">+</span> <span class="token string">&quot; in &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mWM<span class="token punctuation">.</span><span class="token function">removeView</span><span class="token punctuation">(</span>mView<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>localLOGV<span class="token punctuation">)</span> <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;ADD! &quot;</span> <span class="token operator">+</span> mView <span class="token operator">+</span> <span class="token string">&quot; in &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Since the notification manager service cancels the token right</span>
            <span class="token comment">// after it notifies us to cancel the toast there is an inherent</span>
            <span class="token comment">// race and we may attempt to add a window after the token has been</span>
            <span class="token comment">// invalidated. Let us hedge against that.</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                mWM<span class="token punctuation">.</span><span class="token function">addView</span><span class="token punctuation">(</span>mView<span class="token punctuation">,</span> mParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">trySendAccessibilityEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">WindowManager<span class="token punctuation">.</span>BadTokenException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// \u{1F448}\u{1F448}\u{1F448}\u{1F448} \u5FFD\u7565\u6389\u5F02\u5E38</span>
                <span class="token comment">/* ignore */</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><p>\u6240\u4EE5\uFF0C<em>Booster</em> \u4E5F\u7B80\u5355\u7C97\u66B4\u7684\u5C06\u5F02\u5E38 <code>catch</code> \u4F4F\uFF0C\u53EA\u4E0D\u8FC7\uFF0C<code>catch</code> \u7684\u4E0D\u662F <code>mWM.addView(mView, mParams)</code>\uFF0C\u800C\u662F <code>Toast$TN</code> \u8FD9\u4E2A\u5185\u90E8\u7C7B\u7684 <code>mHandler</code>\uFF0C\u7ED9\u5B83\u8BBE\u7F6E\u4E00\u4E2A <code>Handler.Callback</code>\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShadowToast</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * Fix <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token class-name">WindowManager</span>$<span class="token class-name">BadTokenException</span></span></span><span class="token punctuation">}</span> for Android N
     *
     * <span class="token keyword">@param</span> <span class="token parameter">toast</span>
     *         The original toast
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Toast</span> toast<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Build</span><span class="token punctuation">.</span><span class="token constant">VERSION</span><span class="token punctuation">.</span><span class="token constant">SDK_INT</span> <span class="token operator">==</span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">workaround</span><span class="token punctuation">(</span>toast<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            toast<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Toast</span> <span class="token function">workaround</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Toast</span> toast<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">Object</span> tn <span class="token operator">=</span> <span class="token function">getFieldValue</span><span class="token punctuation">(</span>toast<span class="token punctuation">,</span> <span class="token string">&quot;mTN&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> tn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Field mTN of &quot;</span> <span class="token operator">+</span> toast <span class="token operator">+</span> <span class="token string">&quot; is null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> toast<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token class-name">Object</span> handler <span class="token operator">=</span> <span class="token function">getFieldValue</span><span class="token punctuation">(</span>tn<span class="token punctuation">,</span> <span class="token string">&quot;mHandler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token keyword">instanceof</span> <span class="token class-name">Handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setFieldValue</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> <span class="token string">&quot;mCallback&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">CaughtCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Handler</span><span class="token punctuation">)</span> handler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> toast<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token class-name">Object</span> show <span class="token operator">=</span> <span class="token function">getFieldValue</span><span class="token punctuation">(</span>tn<span class="token punctuation">,</span> <span class="token string">&quot;mShow&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>show <span class="token keyword">instanceof</span> <span class="token class-name">Runnable</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setFieldValue</span><span class="token punctuation">(</span>tn<span class="token punctuation">,</span> <span class="token string">&quot;mShow&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">CaughtRunnable</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span><span class="token punctuation">)</span> show<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> toast<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Neither field mHandler nor mShow of &quot;</span> <span class="token operator">+</span> tn <span class="token operator">+</span> <span class="token string">&quot; is accessible&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> toast<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div>`,11),k={href:"https://github.com/didi/booster/blob/master/booster-transform-toast",target:"_blank",rel:"noopener noreferrer"},m=s("code",null,"Toast",-1),b=s("code",null,"show()",-1),d=s("code",null,"ShadowToast.show(Toast)",-1),w=s("h2",{id:"\u5982\u4F55\u4F7F\u7528",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#\u5982\u4F55\u4F7F\u7528","aria-hidden":"true"},"#"),n(" \u5982\u4F55\u4F7F\u7528")],-1),g=s("code",null,"Toast",-1),y=s("em",null,"Android 7.1",-1),f={href:"https://github.com/didi/booster/blob/master/booster-transform-toast",target:"_blank",rel:"noopener noreferrer"},h=t(`<div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>buildscript <span class="token punctuation">{</span>
    ext <span class="token punctuation">{</span>
        kotlin_version <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">&quot;1.5.31&quot;</span></span>
        booster_version <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">&quot;4.16.3&quot;</span></span>
    <span class="token punctuation">}</span>
    repositories <span class="token punctuation">{</span>
        <span class="token function">mavenLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">mavenCentral</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">google</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">jcenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        maven <span class="token punctuation">{</span> url <span class="token string">&#39;https://oss.sonatype.org/content/repositories/public/&#39;</span> <span class="token punctuation">}</span>
        maven <span class="token punctuation">{</span> url <span class="token string">&#39;https://oss.sonatype.org/content/repositories/snapshots/&#39;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    dependencies <span class="token punctuation">{</span>
        classpath <span class="token string">&#39;com.android.tools.build:gradle:3.5.0&#39;</span>
        classpath <span class="token interpolation-string"><span class="token string">&quot;org.jetbrains.kotlin:kotlin-gradle-plugin:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">kotlin_version</span></span><span class="token string">&quot;</span></span>
        classpath <span class="token interpolation-string"><span class="token string">&quot;com.didiglobal.booster:booster-gradle-plugin:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">booster_version</span></span><span class="token string">&quot;</span></span>

        <span class="token comment">/* \u{1F447}\u{1F447}\u{1F447}\u{1F447} \u5F15\u7528\u8FD9\u4E2A\u6A21\u5757 \u{1F447}\u{1F447}\u{1F447}\u{1F447} */</span>
        classpath <span class="token interpolation-string"><span class="token string">&quot;com.didiglobal.booster:booster-transform-toast:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">booster_version</span></span><span class="token string">&quot;</span></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div>`,1);function v(T,V){const a=o("ExternalLinkIcon");return e(),c(l,null,[r,s("p",null,[n("\u5728 "),s("a",k,[n("booster-transform-toast"),p(a)]),n(" \u4E2D\uFF0C\u5C06 "),m,n(" \u7C7B\u53CA\u5176\u5B50\u7C7B\u7684 "),b,n(" \u65B9\u6CD5\u8C03\u7528\u66FF\u6362\u6210 "),d,n("\u3002")]),w,s("p",null,[n("\u4FEE\u590D "),g,n(" \u5728 "),y,n(" \u7684 bug \u53EA\u9700\u8981\u5F15\u5165 "),s("a",f,[n("booster-transform-toast"),p(a)]),n(" \u5373\u53EF\uFF0C\u5982\u4E0B\u6240\u793A\uFF1A")]),h],64)}var N=u(i,[["render",v]]);export{N as default};
